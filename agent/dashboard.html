<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FieldNote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .status-loader {
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        .status-loader.fading-out {
            opacity: 0;
        }
        .status-loader-text {
            display: inline-block;
            position: relative;
            transition: opacity 0.3s ease-in-out;
        }
        .status-loader-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(200,200,200,0.3), transparent);
            animation: shimmer 2s infinite ease-in-out;
        }
        @keyframes shimmer {
            0% { transform: translateX(0); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <div class="h-screen bg-white text-black font-mono relative overflow-hidden">
        <aside class="absolute left-0 top-0 w-80 h-full border-r-2 border-black bg-gray-50 flex flex-col z-20"><div class="p-4 border-b-2 border-black flex-shrink-0"><div class="flex items-center"><img alt="FieldNote Logo" loading="lazy" width="32" height="32" src="https://img.icons8.com/ios/50/000000/search-engine-optimization.png"><h1 class="text-xl font-bold ml-3">FieldNote</h1></div></div><div class="p-4 flex-1 flex flex-col overflow-hidden"><h2 class="text-lg font-bold mb-4 flex-shrink-0">Projects</h2><div id="projects-list" class="flex-1 overflow-y-auto custom-scrollbar"><p class="text-sm text-gray-500">No projects yet.</p></div></div><div class="p-4 border-t-2 border-black flex-shrink-0"><div class="flex items-center justify-between gap-2"><div class="text-xs"><p class="font-semibold truncate max-w-[7rem]">new-user</p><p class="text-gray-600 truncate max-w-[7rem]">user@email.com</p></div><div class="flex gap-2"><button class="px-3 py-1 text-xs border-2 border-black rounded hover:bg-black hover:text-white">Profile</button><button class="px-3 py-1 text-xs border-2 border-black rounded hover:bg-black hover:text-white">Sign out</button></div></div></div></aside>
        <main id="main-content" class="ml-80 h-full flex items-center justify-center p-8"><div id="initial-view" class="flex flex-col items-center justify-center h-full text-center px-4"><h2 class="text-3xl font-bold text-black mb-3">Deploy Your AI Strategist</h2><p class="text-gray-600 text-lg max-w-md mb-8">Enter a website URL to begin the discovery and analysis process.</p><form id="analysis-form" class="w-full max-w-xl"><input id="url-input" name="url" type="url" required placeholder="https://your-website.com" class="w-full px-4 py-3 bg-white text-black border-2 border-black focus:outline-none font-mono"><button type="submit" class="mt-6 w-full px-6 py-3 bg-black text-white font-bold rounded-md shadow-lg hover:bg-gray-800">Start Analysis</button></form></div><div id="chat-container" class="hidden w-full h-full flex-col"><header class="flex items-center justify-between px-4 py-2 border-b-2 border-black flex-shrink-0"><h3 id="chat-header" class="font-bold">SEO Strategy Session</h3></header><div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar"></div><div class="p-4 border-t-2 border-black"><form id="chat-form" class="flex items-center space-x-2"><input id="chat-input" type="text" placeholder="Type your response..." class="flex-1 w-full px-4 py-2 bg-white text-black border-2 border-black focus:outline-none font-mono" autocomplete="off"><button type="submit" class="px-6 py-3 bg-black text-white font-bold rounded-md hover:bg-gray-800">Send</button></form></div></div></main>
    </div>
    
    <!-- Modals -->
    <!-- DEFINITIVELY FIXED: Removed the conflicting 'flex' class. -->
    <div id="review-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
        <div class="bg-white border-2 border-black rounded-lg w-full max-w-6xl max-h-[90vh] flex flex-col"><div class="p-4 border-b-2 border-black flex justify-between items-center"><h2 class="text-xl font-bold">Review Action Plan</h2><button id="close-review-modal" class="font-bold text-2xl">&times;</button></div><div id="review-content" class="p-6 overflow-y-auto"></div></div>
    </div>
    <div id="keys-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 items-center justify-center p-4">
        <div class="bg-white border-2 border-black rounded-lg w-full max-w-lg"><div class="p-4 border-b-2 border-black flex justify-between items-center"><h2 class="text-xl font-bold">Provide Credentials & Execute</h2><button id="close-keys-modal" class="font-bold text-2xl">&times;</button></div><div class="p-6"><form id="keys-form"><div class="space-y-4"><p>To connect to <strong id="cms-name">Platform</strong>, please provide your credentials.</p><div><label for="api-key-user" class="block text-sm font-bold">Username / Key</label><input id="api-key-user" type="text" class="w-full mt-1 px-3 py-2 border-2 border-black" placeholder="e.g., your admin username"></div><div><label for="api-key-password" class="block text-sm font-bold">Password / Secret</label><input id="api-key-password" type="password" class="w-full mt-1 px-3 py-2 border-2 border-black" placeholder="e.g., an Application Password"></div><button type="submit" class="mt-4 w-full bg-black text-white font-bold py-3">Approve & Execute Plan</button></div></form></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const el = id => document.getElementById(id);
            const analysisForm = el('analysis-form'), chatForm = el('chat-form'), keysForm = el('keys-form');
            const initialView = el('initial-view'), chatContainer = el('chat-container');
            const chatMessages = el('chat-messages'), chatInput = el('chat-input'), urlInput = el('url-input');
            const chatHeader = el('chat-header'), projectsList = el('projects-list');
            const reviewModal = el('review-modal'), keysModal = el('keys-modal'), reviewContent = el('review-content');
            let sessionId = null, currentPlatform = 'CMS';

            const toggleModal = (modal, show) => {
                if (show) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            };

            el('close-review-modal').onclick = () => toggleModal(reviewModal, false);
            el('close-keys-modal').onclick = () => toggleModal(keysModal, false);

            analysisForm.addEventListener('submit', async e => {
                e.preventDefault(); const url = urlInput.value; if (!url) return;
                try {
                    const res = await fetch('/api/session/start', { method: 'POST' });
                    sessionId = (await res.json()).session_id;
                    initialView.style.display = 'none';
                    chatContainer.classList.remove('hidden');
                    chatContainer.classList.add('flex');
                    chatHeader.textContent = `Strategy Session: ${new URL(url).hostname}`;
                    addProjectToSidebar(url, sessionId);
                    addUserMessage(url);
                    await sendChatMessage(`analyze: ${url}`);
                } catch (err) { alert('Error starting session. Is the local server running?'); }
            });

            chatForm.addEventListener('submit', async e => {
                e.preventDefault(); const msg = chatInput.value.trim(); if (!msg) return;
                addUserMessage(msg); chatInput.value = '';
                await sendChatMessage(msg);
            });

            keysForm.addEventListener('submit', async e => {
                e.preventDefault();
                const creds = { user: el('api-key-user').value, password: el('api-key-password').value };
                if (!creds.user || !creds.password) { alert("Credentials are required."); return; }
                toggleModal(keysModal, false);
                await sendExecuteRequest(creds);
            });

            chatMessages.addEventListener('click', e => {
                const target = e.target.closest('[data-action]'); if (!target) return;
                const { action, label } = target.dataset;
                if (action === 'review_changes') handleReviewChanges();
                if (action === 'provide_keys') {
                    currentPlatform = label.split(' ')[1] || 'CMS';
                    el('cms-name').textContent = currentPlatform;
                    toggleModal(keysModal, true);
                }
            });

            function addAgentMessage(agent, text, actions = []) {
                const messageEl = document.createElement('div');
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>').replace(/\* /g, '<br> &bull; ');
                let actionButtons = (actions || []).map(a => `<button data-action="${a.type}" data-label="${a.label}" class="mt-2 px-4 py-1 text-sm border-2 border-black rounded hover:bg-black hover:text-white">${a.label}</button>`).join(' ');
                
                messageEl.innerHTML = `<div class="flex items-start space-x-3"><div class="flex-shrink-0 h-8 w-8 bg-gray-800 text-white flex items-center justify-center rounded-full font-bold text-sm">F</div><div class="bg-gray-100 p-3 rounded-lg max-w-lg"><p>${formattedText}</p><div class="flex flex-wrap gap-2">${actionButtons}</div></div></div>`;
                chatMessages.append(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function sendChatMessage(message) { await sendRequest('/api/session/' + sessionId + '/chat', { message }); }
            async function sendExecuteRequest(creds) { await sendRequest('/api/session/' + sessionId + '/execute', { creds }); }
            
            async function sendRequest(endpoint, body) {
                const statusLoaderId = `status-${Date.now()}`;
                createStatusLoader(statusLoaderId, "Thinking...");

                try {
                    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                    const data = await res.json();
                    
                    const statusLoader = el(statusLoaderId);
                    let isFinalMessage = false;

                    for (const msg of data.messages) {
                        if (msg.status === 'in_progress') {
                            updateStatusLoader(statusLoader, msg.text);
                            await new Promise(resolve => setTimeout(resolve, 1200));
                        } else {
                            isFinalMessage = true;
                            if (statusLoader) {
                                statusLoader.classList.add('fading-out');
                                setTimeout(() => {
                                    statusLoader.remove();
                                    addAgentMessage(msg.agent, msg.text, msg.actions);
                                }, 300);
                            } else {
                                addAgentMessage(msg.agent, msg.text, msg.actions);
                            }
                        }
                    }
                    if (!isFinalMessage && el(statusLoaderId)) {
                        el(statusLoaderId).remove();
                    }

                } catch (error) {
                    el(statusLoaderId)?.remove();
                    addAgentMessage('system', 'Sorry, an error occurred. Please check the server logs.');
                    console.error('Request Error:', error);
                }
            }

            function createStatusLoader(id, initialText) {
                const existingLoader = chatMessages.querySelector('.status-loader');
                if (existingLoader) existingLoader.remove();

                const loaderEl = document.createElement('div');
                loaderEl.id = id;
                loaderEl.className = 'status-loader';
                loaderEl.innerHTML = `<div class="flex items-start space-x-3"><div class="flex-shrink-0 h-8 w-8 bg-gray-800 text-white flex items-center justify-center rounded-full font-bold text-sm">F</div><div class="bg-gray-100 p-3 rounded-lg max-w-lg"><span class="status-loader-text">${initialText}</span></div></div>`;
                chatMessages.append(loaderEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function updateStatusLoader(loader, newText) {
                if (loader) {
                    const textEl = loader.querySelector('.status-loader-text');
                    textEl.style.opacity = '0';
                    setTimeout(() => {
                        textEl.textContent = newText;
                        textEl.style.opacity = '1';
                    }, 300);
                }
            }
            
            function addProjectToSidebar(url, id) { if (projectsList.querySelector('p')) projectsList.innerHTML = ''; const div = document.createElement('div'); div.className = 'p-3 border-2 border-black bg-white rounded-lg cursor-pointer'; div.innerHTML = `<h3 class="font-semibold text-sm truncate">Audit: ${new URL(url).hostname}</h3><p class="text-xs text-gray-600 mt-1">${new Date().toLocaleDateString()}</p>`; projectsList.prepend(div); }
            function addUserMessage(text) { const messageEl = document.createElement('div'); messageEl.className = 'flex justify-end'; messageEl.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-lg">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`; chatMessages.append(messageEl); chatMessages.scrollTop = chatMessages.scrollHeight; }
            
            async function handleReviewChanges() {
                const res = await fetch(`/api/session/${sessionId}/review`);
                const data = await res.json();
                const contextRes = await fetch(`/api/session/${sessionId}/context`);
                const context = await contextRes.json();
                let html = '<div>Failed to load review data.</div>';
                if (data && !data.error && context && context.website) {
                    const formatHtml = (rawHtml) => rawHtml ? rawHtml.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                    const onPageProposalsHtml = (data.onpage_seo || []).map(proposal => {
                        const originalPage = context.website.pages.find(p => p.url === proposal.page_url);
                        return `<div class="mb-4 border-t-2 border-gray-200 pt-2"><h4 class="font-bold">Page: ${proposal.page_url}</h4><p class="text-sm mb-2">Reason: <strong>${proposal.reason}</strong></p><div class="grid grid-cols-2 gap-4"><div><h5 class="font-bold text-center">Before</h5><pre class="bg-gray-100 p-2 text-xs overflow-auto max-h-80 border-2 border-black">${originalPage ? formatHtml(originalPage.html) : 'Original HTML not found.'}</pre></div><div><h5 class="font-bold text-center">After (Proposed Rewrite)</h5><pre class="bg-green-50 p-2 text-xs overflow-auto max-h-80 border-2 border-green-800">${formatHtml(proposal.proposed_html_body)}</pre></div></div><h5 class="font-bold text-center mt-2">Proposed Schema</h5><pre class="bg-blue-50 p-2 text-xs overflow-auto max-h-60 border-2 border-blue-800">${JSON.stringify(proposal.proposed_schema, null, 2)}</pre></div>`;
                    }).join('');
                    html = `<div class="mb-6"><h3 class="text-lg font-bold mb-2 border-b-2 border-black">On-Page SEO Full Rewrites</h3>${onPageProposalsHtml || '<p>No on-page proposals available.</p>'}</div><div class="mb-6"><h3 class="text-lg font-bold mb-2 border-b-2 border-black">Meta Tag Optimizations</h3><pre class="bg-gray-100 p-2 text-xs overflow-auto max-h-60 border-2 border-black">${JSON.stringify(data.meta_optimization, null, 2)}</pre></div><div><h3 class="text-lg font-bold mb-2 border-b-2 border-black">Scheduled Blog Drafts</h3><pre class="bg-gray-100 p-2 text-xs overflow-auto max-h-60 border-2 border-black">${JSON.stringify(data.blog_automation, null, 2)}</pre></div>`;
                }
                reviewContent.innerHTML = html;
                toggleModal(reviewModal, true);
            }
        });
    </script>
</body>
</html>